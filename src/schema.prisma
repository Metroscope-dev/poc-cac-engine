datasource db {
  provider = "postgresql"
  url      = env("DATASOURCE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
  binaryTargets   = ["native", "linux-musl"]
}

model User {
  name String @id

  reportSettings String
  reports        Report[] //One report per Serie

  computation Computation[]

  @@map("user")
}

model Serie {
  name        String  @id
  description String?

  values        Value[] //One per Date
  stats         Stats? //When calculated
  computedSerie ComputedSerie? //Can be a ComputedSerie
  graphs        Report[] //One per User

  computation Computation[]

  @@map("serie")
}

model ComputedSerie {
  serie      Serie  @relation(fields: [serie_name], references: [name])
  serie_name String @unique

  formula String

  @@map("computed_serie")
}

model Value {
  date       DateTime
  serie      Serie    @relation(fields: [serie_name], references: [name])
  serie_name String

  number Float

  outdatedAt DateTime?

  @@id([date, serie_name])
  @@index([serie_name, date])
  @@map("value")
}

model Stats {
  serie      Serie  @relation(fields: [serie_name], references: [name])
  serie_name String @unique

  valueCount Int

  outdatedAt DateTime?

  @@map("stats")
}

model Report {
  serie      Serie  @relation(fields: [serie_name], references: [name])
  serie_name String

  user      User   @relation(fields: [user_name], references: [name])
  user_name String

  content String

  outdatedAt DateTime?

  @@id([serie_name, user_name])
  @@map("report")
}

enum Progress {
  WAITING
  RUNNING
  ERROR
  SUCCESS
}

model Computation {
  id String @id

  date       DateTime?
  serie      Serie?    @relation(fields: [serie_name], references: [name])
  serie_name String?   @unique
  user       User?     @relation(fields: [user_name], references: [name])
  user_name  String?

  function_name String

  inputHash  String
  outdatedAt DateTime?
  progress   Progress  @default(WAITING)
  updatedAt  DateTime  @updatedAt

  @@unique([date, serie_name, user_name])
  @@map("computation")
}
